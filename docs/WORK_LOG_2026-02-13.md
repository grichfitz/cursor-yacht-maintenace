# Work Log — 2026-02-13 (User Management + Editor UI + Visibility)

## Summary

Tonight we implemented the first usable **User Management** flow in the Admin-only Editor, aligned Editor UIs to a consistent **TreeDisplay** pattern, and fixed a critical visibility issue where non-admin users could see yachts outside of their groups.

This was **frontend-only application logic** (no schema/auth/trigger refactors in the app code). The remaining work is largely **permissions / RLS enforcement** to make the database enforce the same visibility rules the UI now assumes.

---

## Key Outcomes

### 1) User Management (Admin-only)

**Goal:** Admin can list users, open a per-user settings page, update role, and manage group membership.

**Implemented:**
- `/users` now shows an **Editor-styled directory list** of users with a single **Edit** button per row.
- `/users/:userId` is a **User Settings** page:
  - Edit `users.role` (`crew`, `manager`, `admin`) with explicit Save
  - Assign group memberships via `user_group_links` using the **TreeDisplay** assignment UI
- `/users/:userId/groups` exists as a dedicated group assignment page (tree UI). (This is now somewhat redundant with `/users/:userId`, but kept for flexibility.)

**Data touched (reads/writes):**
- Reads: `users (id,email,role)`, `groups`, `user_group_links`
- Writes: `users.role`, `user_group_links` (checkbox toggles apply immediately via existing assignment component)

**Files:**
- `src/pages/UsersPage.tsx` (user directory list)
- `src/pages/editor/EditorUserPage.tsx` (user settings: role + group membership)
- `src/pages/editor/EditorUserGroupsPage.tsx` (tree membership page)

---

### 2) Editor UI consistency: TreeDisplay for groups (and nesting)

We standardized the “groups tree” presentation to use the existing `TreeDisplay` component (rounded rows, chevrons, right-side actions), matching the visual style you liked.

**Editor · Groups**
- Group list now uses `TreeDisplay`
- Edit/Delete actions live on the right of each group row
- Editing happens in a separate “Edit group” card so the tree stays visually consistent

**Editor · Yachts**
- Yachts are shown as **child nodes under their groups** in `TreeDisplay`
- Group rows show a count on the right
- Yacht rows have Edit/Delete actions on the right
- “Unknown group” yachts show under a virtual “Unknown group” node

**Files:**
- `src/pages/editor/EditorGroupsPage.tsx`
- `src/pages/editor/EditorYachtsPage.tsx`
- `src/components/TreeDisplay.tsx` (reused, not redesigned)
- `src/App.css` already contains the TreeDisplay styling (used as the source-of-truth look)

---

### 3) Yacht visibility fix (non-admin sees only their group’s yachts)

**Bug:** Logged in as a non-admin user (e.g. `charlie.whattleworth`), the app showed **all yachts**.

**Fix (frontend enforcement):**
- `YachtsPage` now filters the yachts query for non-admins using the user’s `user_group_links`.
- `YachtPage` now blocks direct access to yacht details unless the yacht’s `group_id` is one of the user’s linked groups (unless `admin`).

**Files:**
- `src/pages/YachtsPage.tsx`
- `src/pages/YachtPage.tsx`

**Important note:** This is still **application-layer** filtering. It must be backed by **database RLS** to be secure.

---

### 4) Navigation

Added **Users** to the Editor top navigation so admins can reach the new page naturally.

**Files:**
- `src/pages/editor/EditorNav.tsx`

---

### 5) Diagnostics tooling (optional but helpful)

Added a Node script to run DB diagnostics queries against Supabase Postgres via a connection string, useful for permissions/visibility debugging and template instance investigations.

**Commands:**
- `npm run diagnostics`
  - Requires env var: `SUPABASE_DB_URL` (or `DATABASE_URL` / `POSTGRES_URL`)

**Files:**
- `scripts/run_diagnostics.mjs`
- `package.json` / `package-lock.json` (adds dependency `pg` and a `diagnostics` script)

---

### 6) “Always use this tree style” guideline

Created a Cursor rule to keep **group tree** / **category tree** UIs consistent going forward:

**File:**
- `.cursor/rules/tree-ui-patterns.mdc`

---

## Routes Added / Updated

Added or updated routes (all wrapped in `EditorRoute` where appropriate):
- `/users` (Editor/admin-only): user directory list
- `/users/:userId` (Editor/admin-only): user settings (role + groups)
- `/users/:userId/groups` (Editor/admin-only): user group assignment tree

Route file:
- `src/app/routes.tsx`

---

## Notes on Permissions Work Remaining (High Priority)

The UI now assumes these authorization rules:
- **Group membership controls yacht visibility** (crew/manager should only see yachts in their groups)
- **Admin controls the Editor**
- Group membership edits (`user_group_links`) are admin-only

To complete this securely, the database needs RLS/policies that enforce:
- `select` on `yachts` limited to yachts whose `group_id` is in the signed-in user’s visible groups
- `select` on `user_group_links` and `insert/delete` restricted to admins (or service role)
- Ensure any “task” visibility paths (task_instances by yacht) follow the same visibility constraints

Right now, the frontend blocks access, but **RLS must be the final authority**.

---

## Files intentionally NOT committed (to avoid leaking data)

These items were present locally but should be reviewed before committing:
- `docs/Supabase Snippet Untitled query (1).csv` (may contain sensitive exports)
- `auth/` (appears to be a duplicate/stray folder vs `src/auth/`)
- `migration_*.sql` (schema/RLS migrations should be committed only when we’re ready to apply them)

