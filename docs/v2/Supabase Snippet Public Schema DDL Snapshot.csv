ddl
--- TABLES ---
"create table public.category_templates (
  category_id uuid not null,
  global_template_id uuid not null
);
"
"create table public.global_templates (
  id uuid default uuid_generate_v4() not null,
  title text not null,
  description text,
  interval_days integer,
  checklist_json jsonb,
  archived_at timestamp with time zone
);
"
"create table public.group_memberships (
  user_id uuid not null,
  group_id uuid not null,
  created_at timestamp with time zone default now() not null
);
"
"create table public.group_templates (
  id uuid default uuid_generate_v4() not null,
  group_id uuid not null,
  origin_global_template_id uuid,
  title text not null,
  description text,
  interval_days integer,
  checklist_json jsonb,
  active boolean default true not null,
  archived_at timestamp with time zone
);
"
"create table public.groups (
  id uuid default uuid_generate_v4() not null,
  name text not null,
  created_at timestamp with time zone default now() not null,
  archived_at timestamp with time zone,
  parent_group_id uuid
);
"
"create table public.roles (
  id uuid default uuid_generate_v4() not null,
  name text not null
);
"
"create table public.template_categories (
  id uuid default uuid_generate_v4() not null,
  name text not null,
  description text,
  archived_at timestamp with time zone
);
"
"create table public.user_roles (
  user_id uuid not null,
  role_id uuid not null
);
"
"create table public.yacht_owners (
  yacht_id uuid not null,
  user_id uuid not null
);
"
"create table public.yacht_tasks (
  id uuid default uuid_generate_v4() not null,
  yacht_id uuid not null,
  group_template_id uuid,
  origin_global_template_id uuid,
  title text not null,
  description text,
  interval_days integer,
  checklist_json jsonb,
  due_date timestamp with time zone,
  status text not null,
  owner_user_id uuid,
  completed_at timestamp with time zone,
  completed_by uuid,
  approved_at timestamp with time zone,
  approved_by uuid,
  deleted_at timestamp with time zone,
  created_at timestamp with time zone default now() not null
);
"
"create table public.yachts (
  id uuid default uuid_generate_v4() not null,
  group_id uuid not null,
  name text not null,
  archived_at timestamp with time zone
);
"
alter table public.category_templates add constraint category_templates_category_id_fkey FOREIGN KEY (category_id) REFERENCES template_categories(id) ON DELETE RESTRICT;
alter table public.category_templates add constraint category_templates_global_template_id_fkey FOREIGN KEY (global_template_id) REFERENCES global_templates(id) ON DELETE RESTRICT;
"alter table public.category_templates add constraint category_templates_pkey PRIMARY KEY (category_id, global_template_id);"
alter table public.global_templates add constraint global_templates_pkey PRIMARY KEY (id);
alter table public.group_memberships add constraint group_memberships_group_id_fkey FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE RESTRICT;
"alter table public.group_memberships add constraint group_memberships_pkey PRIMARY KEY (user_id, group_id);"
alter table public.group_memberships add constraint group_memberships_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE RESTRICT;
alter table public.group_templates add constraint group_templates_group_id_fkey FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE RESTRICT;
alter table public.group_templates add constraint group_templates_origin_global_template_id_fkey FOREIGN KEY (origin_global_template_id) REFERENCES global_templates(id) ON DELETE RESTRICT;
alter table public.group_templates add constraint group_templates_pkey PRIMARY KEY (id);
alter table public.groups add constraint groups_parent_group_id_fkey FOREIGN KEY (parent_group_id) REFERENCES groups(id) ON DELETE RESTRICT;
alter table public.groups add constraint groups_pkey PRIMARY KEY (id);
alter table public.roles add constraint roles_name_key UNIQUE (name);
alter table public.roles add constraint roles_pkey PRIMARY KEY (id);
alter table public.template_categories add constraint template_categories_pkey PRIMARY KEY (id);
alter table public.user_roles add constraint user_roles_pkey PRIMARY KEY (user_id);
alter table public.user_roles add constraint user_roles_role_id_fkey FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE RESTRICT;
alter table public.user_roles add constraint user_roles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE RESTRICT;
"alter table public.yacht_owners add constraint yacht_owners_pkey PRIMARY KEY (yacht_id, user_id);"
alter table public.yacht_owners add constraint yacht_owners_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE RESTRICT;
alter table public.yacht_owners add constraint yacht_owners_yacht_id_fkey FOREIGN KEY (yacht_id) REFERENCES yachts(id) ON DELETE RESTRICT;
alter table public.yacht_tasks add constraint yacht_tasks_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES auth.users(id) ON DELETE RESTRICT;
alter table public.yacht_tasks add constraint yacht_tasks_completed_by_fkey FOREIGN KEY (completed_by) REFERENCES auth.users(id) ON DELETE RESTRICT;
alter table public.yacht_tasks add constraint yacht_tasks_group_template_id_fkey FOREIGN KEY (group_template_id) REFERENCES group_templates(id) ON DELETE RESTRICT;
alter table public.yacht_tasks add constraint yacht_tasks_origin_global_template_id_fkey FOREIGN KEY (origin_global_template_id) REFERENCES global_templates(id) ON DELETE RESTRICT;
alter table public.yacht_tasks add constraint yacht_tasks_owner_user_id_fkey FOREIGN KEY (owner_user_id) REFERENCES auth.users(id) ON DELETE RESTRICT;
alter table public.yacht_tasks add constraint yacht_tasks_pkey PRIMARY KEY (id);
"alter table public.yacht_tasks add constraint yacht_tasks_status_check CHECK ((status = ANY (ARRAY['open'::text, 'pending_review'::text, 'approved'::text])));"
alter table public.yacht_tasks add constraint yacht_tasks_yacht_id_fkey FOREIGN KEY (yacht_id) REFERENCES yachts(id) ON DELETE RESTRICT;
alter table public.yachts add constraint yachts_group_id_fkey FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE RESTRICT;
alter table public.yachts add constraint yachts_pkey PRIMARY KEY (id);
CREATE INDEX idx_groups_parent_group_id ON public.groups USING btree (parent_group_id);
"CREATE UNIQUE INDEX yacht_tasks_unique_open_per_yacht_global_template ON public.yacht_tasks USING btree (yacht_id, origin_global_template_id) WHERE ((origin_global_template_id IS NOT NULL) AND (deleted_at IS NULL) AND (status <> 'approved'::text));"
"CREATE UNIQUE INDEX yacht_tasks_unique_open_per_yacht_group_template ON public.yacht_tasks USING btree (yacht_id, group_template_id) WHERE ((group_template_id IS NOT NULL) AND (deleted_at IS NULL) AND (status <> 'approved'::text));"
--- VIEWS ---
--- FUNCTIONS ---
"CREATE OR REPLACE FUNCTION public.approve_yacht_task(p_task_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
declare
v_task public.yacht_tasks%rowtype;
v_role text;
begin
select *
into v_task
from public.yacht_tasks
where id = p_task_id
for update;
if not found then
raise exception 'task not found: %', p_task_id;
end if;
v_role := public.current_user_role();
if not (
public.is_admin()
or (
v_role = 'manager'
and v_task.yacht_id in (select public.user_yacht_ids())
)
) then
raise exception 'not authorized';
end if;
if v_task.status <> 'pending_review' then
raise exception 'invalid state: expected pending_review, got %', v_task.status;
end if;
update public.yacht_tasks
set
status = 'approved',
approved_at = now(),
approved_by = auth.uid()
where id = p_task_id;
if v_task.interval_days is not null then
if v_task.completed_at is null then
raise exception 'invalid state: completed_at is null for task %', p_task_id;
end if;
insert into public.yacht_tasks (
yacht_id,
group_template_id,
origin_global_template_id,
title,
description,
interval_days,
checklist_json,
due_date,
status
)
values (
v_task.yacht_id,
v_task.group_template_id,
v_task.origin_global_template_id,
v_task.title,
v_task.description,
v_task.interval_days,
v_task.checklist_json,
v_task.completed_at + (v_task.interval_days * interval '1 day'),
'open'
)
on conflict do nothing;
end if;
end;
$function$
"
"CREATE OR REPLACE FUNCTION public.assign_category_to_yacht(p_category_id uuid, p_yacht_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
declare
v_role text;
begin
v_role := public.current_user_role();
if not (
public.is_admin()
or (
v_role = 'manager'
and p_yacht_id in (select public.user_yacht_ids())
)
) then
raise exception 'not authorized';
end if;
insert into public.yacht_tasks (
yacht_id,
group_template_id,
origin_global_template_id,
title,
description,
interval_days,
checklist_json,
due_date,
status
)
select
p_yacht_id,
null,
gt.id,
gt.title,
gt.description,
gt.interval_days,
gt.checklist_json,
now(),
'open'
from public.global_templates gt
join public.category_templates ct
on ct.global_template_id = gt.id
where ct.category_id = p_category_id
and not exists (
select 1
from public.yacht_tasks yt
left join public.group_templates gpt
on gpt.id = yt.group_template_id
where yt.yacht_id = p_yacht_id
and yt.deleted_at is null
and yt.status <> 'approved'
and (
yt.origin_global_template_id = gt.id
or gpt.origin_global_template_id = gt.id
)
)
on conflict do nothing;
return;
end;
$function$
"
"CREATE OR REPLACE FUNCTION public.assign_global_template_to_group(p_global_template_id uuid, p_group_id uuid)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
declare
v_new_group_template_id uuid;
v_role text;
v_gt public.global_templates%rowtype;
begin
v_role := public.current_user_role();
if not (
public.is_admin()
or (
v_role = 'manager'
and p_group_id in (select public.user_group_ids())
)
) then
raise exception 'not authorized';
end if;
if exists (
select 1
from public.group_templates gt
where gt.group_id = p_group_id
and gt.origin_global_template_id = p_global_template_id
and gt.archived_at is null
) then
raise exception 'group_template already exists for global_template % and group %', p_global_template_id, p_group_id;
end if;
select *
into v_gt
from public.global_templates
where id = p_global_template_id;
if not found then
raise exception 'global_template not found: %', p_global_template_id;
end if;
insert into public.group_templates (
group_id,
origin_global_template_id,
title,
description,
interval_days,
checklist_json,
active
)
values (
p_group_id,
p_global_template_id,
v_gt.title,
v_gt.description,
v_gt.interval_days,
v_gt.checklist_json,
true
)
returning id into v_new_group_template_id;
insert into public.yacht_tasks (
yacht_id,
group_template_id,
title,
description,
interval_days,
checklist_json,
due_date,
status
)
select
y.id,
v_new_group_template_id,
gt.title,
gt.description,
gt.interval_days,
gt.checklist_json,
now(),
'open'
from public.yachts y
join public.group_templates gt
on gt.id = v_new_group_template_id
where y.group_id = p_group_id
on conflict do nothing;
return v_new_group_template_id;
end;
$function$
"
"CREATE OR REPLACE FUNCTION public.complete_yacht_task(p_task_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
declare
v_task public.yacht_tasks%rowtype;
v_role text;
begin
select *
into v_task
from public.yacht_tasks
where id = p_task_id
for update;
if not found then
raise exception 'task not found: %', p_task_id;
end if;
v_role := public.current_user_role();
if not (
public.is_admin()
or (
v_role in ('manager','crew')
and v_task.yacht_id in (select public.user_yacht_ids())
)
) then
raise exception 'not authorized';
end if;
if v_task.status <> 'open' then
raise exception 'invalid state: expected open, got %', v_task.status;
end if;
update public.yacht_tasks
set
status = 'pending_review',
completed_at = now(),
completed_by = auth.uid()
where id = p_task_id;
end;
$function$
"
"CREATE OR REPLACE FUNCTION public.current_user_role()
 RETURNS text
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
select r.name
from public.user_roles ur
join public.roles r on r.id = ur.role_id
where ur.user_id = auth.uid()
limit 1;
$function$
"
"CREATE OR REPLACE FUNCTION public.is_admin()
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
select exists (
select 1
from public.user_roles ur
join public.roles r on r.id = ur.role_id
where ur.user_id = auth.uid()
and r.name = 'admin'
);
$function$
"
"CREATE OR REPLACE FUNCTION public.user_group_ids()
 RETURNS SETOF uuid
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
declare
begin
  if public.is_admin() then
    return query
    select g.id
    from public.groups g;
    return;
  end if;

  return query
  with recursive group_tree as (
    select g.id
    from public.groups g
    join public.group_memberships gm
      on gm.group_id = g.id
    where gm.user_id = auth.uid()

    union all

    select child.id
    from public.groups child
    join group_tree gt
      on child.parent_group_id = gt.id
  )
  select id from group_tree;
end;
$function$
"
"CREATE OR REPLACE FUNCTION public.user_yacht_ids()
 RETURNS SETOF uuid
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
declare
role_name text;
begin
if public.is_admin() then
return query
select y.id
from public.yachts y;
return;
end if;
role_name := public.current_user_role();
if role_name in ('manager', 'crew') then
return query
select y.id
from public.yachts y
where y.group_id in (select public.user_group_ids());
elsif role_name = 'owner' then
return query
select yo.yacht_id
from public.yacht_owners yo
where yo.user_id = auth.uid();
else
return;
end if;
end;
$function$
"
--- TRIGGERS ---
--- RLS ---
alter table public.category_templates enable row level security;
alter table public.global_templates enable row level security;
alter table public.group_memberships enable row level security;
alter table public.group_templates enable row level security;
alter table public.groups enable row level security;
alter table public.template_categories enable row level security;
alter table public.user_roles enable row level security;
alter table public.yacht_owners enable row level security;
alter table public.yacht_tasks enable row level security;
alter table public.yachts enable row level security;
--- RLS POLICIES ---
create policy category_templates_delete_admin on public.category_templates for DELETE to authenticated using (is_admin());
"create policy category_templates_insert_admin on public.category_templates for INSERT to authenticated using (true)
with check (is_admin());"
create policy category_templates_select_admin_all on public.category_templates for SELECT to authenticated using (is_admin());
"create policy category_templates_select_manager_crew_visible on public.category_templates for SELECT to authenticated using ((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])));"
"create policy category_templates_update_admin on public.category_templates for UPDATE to authenticated using (is_admin())
with check (is_admin());"
create policy global_templates_delete_admin on public.global_templates for DELETE to authenticated using (is_admin());
"create policy global_templates_insert_admin on public.global_templates for INSERT to authenticated using (true)
with check (is_admin());"
create policy global_templates_select_admin_all on public.global_templates for SELECT to authenticated using (is_admin());
"create policy global_templates_select_manager_crew_visible on public.global_templates for SELECT to authenticated using ((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])));"
"create policy global_templates_update_admin on public.global_templates for UPDATE to authenticated using (is_admin())
with check (is_admin());"
create policy group_memberships_delete_admin on public.group_memberships for DELETE to authenticated using (is_admin());
"create policy group_memberships_insert_admin on public.group_memberships for INSERT to authenticated using (true)
with check (is_admin());"
create policy group_memberships_select_admin_all on public.group_memberships for SELECT to authenticated using (is_admin());
"create policy group_memberships_select_manager_crew_in_groups on public.group_memberships for SELECT to authenticated using (((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])) AND (group_id IN ( SELECT user_group_ids() AS user_group_ids))));"
create policy group_memberships_select_self on public.group_memberships for SELECT to authenticated using ((user_id = auth.uid()));
"create policy group_memberships_update_admin on public.group_memberships for UPDATE to authenticated using (is_admin())
with check (is_admin());"
create policy group_templates_delete_admin on public.group_templates for DELETE to authenticated using (is_admin());
create policy group_templates_delete_manager_in_groups on public.group_templates for DELETE to authenticated using (((current_user_role() = 'manager'::text) AND (group_id IN ( SELECT user_group_ids() AS user_group_ids))));
"create policy group_templates_insert_admin on public.group_templates for INSERT to authenticated using (true)
with check (is_admin());"
"create policy group_templates_insert_manager_in_groups on public.group_templates for INSERT to authenticated using (true)
with check (((current_user_role() = 'manager'::text) AND (group_id IN ( SELECT user_group_ids() AS user_group_ids))));"
create policy group_templates_select_admin_all on public.group_templates for SELECT to authenticated using (is_admin());
"create policy group_templates_select_manager_crew_in_groups on public.group_templates for SELECT to authenticated using (((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])) AND (group_id IN ( SELECT user_group_ids() AS user_group_ids))));"
"create policy group_templates_update_admin on public.group_templates for UPDATE to authenticated using (is_admin())
with check (is_admin());"
"create policy group_templates_update_manager_in_groups on public.group_templates for UPDATE to authenticated using (((current_user_role() = 'manager'::text) AND (group_id IN ( SELECT user_group_ids() AS user_group_ids))))
with check (((current_user_role() = 'manager'::text) AND (group_id IN ( SELECT user_group_ids() AS user_group_ids))));"
create policy groups_delete_admin on public.groups for DELETE to authenticated using (is_admin());
"create policy groups_insert_admin on public.groups for INSERT to authenticated using (true)
with check (is_admin());"
create policy groups_select_admin_all on public.groups for SELECT to authenticated using (is_admin());
"create policy groups_select_manager_crew_in_groups on public.groups for SELECT to authenticated using (((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])) AND (id IN ( SELECT user_group_ids() AS user_group_ids))));"
"create policy groups_update_admin on public.groups for UPDATE to authenticated using (is_admin())
with check (is_admin());"
create policy template_categories_delete_admin on public.template_categories for DELETE to authenticated using (is_admin());
"create policy template_categories_insert_admin on public.template_categories for INSERT to authenticated using (true)
with check (is_admin());"
create policy template_categories_select_admin_all on public.template_categories for SELECT to authenticated using (is_admin());
"create policy template_categories_select_manager_crew_visible on public.template_categories for SELECT to authenticated using ((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])));"
"create policy template_categories_update_admin on public.template_categories for UPDATE to authenticated using (is_admin())
with check (is_admin());"
create policy user_roles_delete_admin on public.user_roles for DELETE to authenticated using (is_admin());
"create policy user_roles_insert_admin on public.user_roles for INSERT to authenticated using (true)
with check (is_admin());"
create policy user_roles_select_admin_all on public.user_roles for SELECT to authenticated using (is_admin());
create policy user_roles_select_self on public.user_roles for SELECT to authenticated using ((user_id = auth.uid()));
"create policy user_roles_update_admin on public.user_roles for UPDATE to authenticated using (is_admin())
with check (is_admin());"
create policy yacht_owners_delete_admin on public.yacht_owners for DELETE to authenticated using (is_admin());
"create policy yacht_owners_insert_admin on public.yacht_owners for INSERT to authenticated using (true)
with check (is_admin());"
create policy yacht_owners_select_admin_all on public.yacht_owners for SELECT to authenticated using (is_admin());
"create policy yacht_owners_select_manager_crew_in_scope on public.yacht_owners for SELECT to authenticated using (((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));"
create policy yacht_owners_select_owner_self on public.yacht_owners for SELECT to authenticated using (((current_user_role() = 'owner'::text) AND (user_id = auth.uid())));
"create policy yacht_owners_update_admin on public.yacht_owners for UPDATE to authenticated using (is_admin())
with check (is_admin());"
create policy yacht_tasks_delete_admin on public.yacht_tasks for DELETE to authenticated using (is_admin());
create policy yacht_tasks_delete_manager_in_scope on public.yacht_tasks for DELETE to authenticated using (((current_user_role() = 'manager'::text) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));
"create policy yacht_tasks_insert_admin on public.yacht_tasks for INSERT to authenticated using (true)
with check (is_admin());"
"create policy yacht_tasks_insert_crew_in_scope on public.yacht_tasks for INSERT to authenticated using (true)
with check (((current_user_role() = 'crew'::text) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));"
"create policy yacht_tasks_insert_manager_in_scope on public.yacht_tasks for INSERT to authenticated using (true)
with check (((current_user_role() = 'manager'::text) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));"
create policy yacht_tasks_select_admin_all on public.yacht_tasks for SELECT to authenticated using (is_admin());
"create policy yacht_tasks_select_manager_crew_in_scope on public.yacht_tasks for SELECT to authenticated using (((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));"
create policy yacht_tasks_select_owner_approved_in_scope on public.yacht_tasks for SELECT to authenticated using (((current_user_role() = 'owner'::text) AND (status = 'approved'::text) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));
"create policy yacht_tasks_update_admin on public.yacht_tasks for UPDATE to authenticated using (is_admin())
with check (is_admin());"
"create policy yacht_tasks_update_crew_in_scope on public.yacht_tasks for UPDATE to authenticated using (((current_user_role() = 'crew'::text) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))))
with check (((current_user_role() = 'crew'::text) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));"
"create policy yacht_tasks_update_manager_in_scope on public.yacht_tasks for UPDATE to authenticated using (((current_user_role() = 'manager'::text) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))))
with check (((current_user_role() = 'manager'::text) AND (yacht_id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));"
create policy yachts_delete_admin on public.yachts for DELETE to authenticated using (is_admin());
"create policy yachts_insert_admin on public.yachts for INSERT to authenticated using (true)
with check (is_admin());"
create policy yachts_select_admin_all on public.yachts for SELECT to authenticated using (is_admin());
"create policy yachts_select_manager_crew_in_scope on public.yachts for SELECT to authenticated using (((current_user_role() = ANY (ARRAY['manager'::text, 'crew'::text])) AND (id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));"
create policy yachts_select_owner_in_scope on public.yachts for SELECT to authenticated using (((current_user_role() = 'owner'::text) AND (id IN ( SELECT user_yacht_ids() AS user_yacht_ids))));
"create policy yachts_update_admin on public.yachts for UPDATE to authenticated using (is_admin())
with check (is_admin());"