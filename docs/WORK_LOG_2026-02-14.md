# Work Log — 2026-02-14 (Yachts Tree + Editor CRUD Pages + Task Visibility + Ownership)

## Summary

Today we finished the **Yachts tree UI** for the main Yachts tab, simplified Editor “New …” affordances, introduced dedicated **Editor create/edit pages** for core entities, added **hierarchical categories**, and fixed task visibility/ownership so users can **see yacht tasks by group** and **crew can take ownership** (self-assign) from the Yacht screen.

This work spans both:
- **Frontend UX + navigation** improvements
- **Backend RLS/trigger** updates via migrations to align visibility/permissions with the desired operational flow

---

## Key Outcomes

### 1) Yachts tab now mirrors Editor: group tree → yachts

- `/yachts` now renders a **TreeDisplay** with **group hierarchy** and yacht nodes beneath.
- Yacht rows navigate to `/yachts/:id`.
- Only groups with yachts (plus ancestors) appear; unknown groups are bucketed.
- Fixed a React hooks-order crash in `YachtsPage` (hook call moved above early return).

Files:
- `src/pages/YachtsPage.tsx`

---

### 2) Editor navigation + “New …” affordance simplified

- Editor list pages now show a **single full-width “New …” button** (no duplicated card title + button).

Files:
- `src/pages/editor/EditorYachtsPage.tsx`
- `src/pages/editor/EditorGroupsPage.tsx`
- `src/pages/editor/EditorCategoriesPage.tsx`
- `src/pages/editor/EditorTaskTemplatesPage.tsx`
- `src/pages/UsersPage.tsx`

---

### 3) Dedicated Editor create/edit pages (no inline editing)

Admin flows now navigate to dedicated pages for create and edit:
- Yachts: `/editor/yachts/new`, `/editor/yachts/:yachtId`
- Groups: `/editor/groups/new`, `/editor/groups/:groupId`
- Categories: `/editor/categories/new`, `/editor/categories/:categoryId`
- Task templates: `/editor/task-templates/new`, `/editor/task-templates/:templateId`
- Users: `/users/new`

Files:
- `src/app/routes.tsx`
- `src/pages/editor/EditorNewYachtPage.tsx`
- `src/pages/editor/EditorEditYachtPage.tsx`
- `src/pages/editor/EditorNewGroupPage.tsx`
- `src/pages/editor/EditorEditGroupPage.tsx`
- `src/pages/editor/EditorNewCategoryPage.tsx`
- `src/pages/editor/EditorEditCategoryPage.tsx`
- `src/pages/editor/EditorNewTaskTemplatePage.tsx`
- `src/pages/editor/EditorEditTaskTemplatePage.tsx`
- `src/pages/NewUserPage.tsx`

---

### 4) Hierarchical categories (categories within categories)

- Added `parent_category_id` support and UI for selecting parent categories.
- Editor categories list renders as a tree.

Migration:
- `migration_phase1c_categories_hierarchy.sql`

Files:
- `src/pages/editor/EditorNewCategoryPage.tsx`
- `src/pages/editor/EditorEditCategoryPage.tsx`
- `src/pages/editor/EditorCategoriesPage.tsx`

---

### 5) User-group assignment quality-of-life: auto-assign descendants on check

When assigning a user to a group (via the tree UI):
- Checking a parent group auto-checks **all descendants**.
- Descendants can still be manually removed after.

Files:
- `src/pages/GenericTreeAssignPage.tsx`

---

### 6) Task visibility and “take ownership” aligned to groups

New desired behavior:
- If a user is in the yacht’s owning group (or descendant), they can **see all task instances** for that yacht.
- Crew can **Take** a pending task (self-assign), then complete it.

Implemented:
- New RLS + helper functions + trigger update migration.
- Yacht UI: crew sees a **Take** button on pending tasks.

Migration:
- `migration_task_visibility_and_take_ownership.sql`

Files:
- `src/pages/YachtPage.tsx`

---

### 7) Task detail now shows which yacht it belongs to

On `/tasks/:taskInstanceId`, the page now loads and displays the related yacht and links back.

Files:
- `src/pages/TaskInstancePage.tsx`

---

### 8) Seed tooling improvements (random tasks)

- Added `dotenv` so seed scripts can load `.env.local`.
- `scripts/seed_random_tasks.mjs` can fall back to Supabase HTTP mode (requires service role key) when DB DNS is unavailable.

Files:
- `scripts/seed_random_tasks.mjs`
- `package.json`, `package-lock.json`

---

## Notes / Operational Reminders

- **Supabase hook**: if you rely on JWT role claims, ensure the Custom Access Token Hook is enabled as described in `migration_phase1_roles_editor_operations.sql`.
- **Seeding**: direct Postgres host may fail DNS on some networks; HTTP mode works with `SUPABASE_SERVICE_ROLE_KEY` in `.env.local`.

---

## Files intentionally NOT committed

- `docs/Supabase Snippet Untitled query (1).csv` (treat as a local export; review before committing)

