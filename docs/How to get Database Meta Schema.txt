/* =========================================================
   MARINE TASK APP â€” FULL DATABASE SNAPSHOT (v2)
   Cleaner + More Complete + Supabase-aware
   ========================================================= */

with user_schemas as (
  select schema_name
  from information_schema.schemata
  where schema_name not in (
    'pg_catalog',
    'information_schema',
    'pg_toast',
    'extensions'
  )
)

-- =========================================================
-- SCHEMAS
-- =========================================================
select
  'SCHEMAS' as section,
  s.schema_name::text as a1,
  null::text as a2,
  null::text as a3,
  null::text as a4,
  null::text as a5,
  null::text as a6,
  null::text as a7
from user_schemas s

union all

-- =========================================================
-- TABLES (includes partitioned)
-- =========================================================
select
  'TABLES',
  n.nspname::text,
  c.relname::text,
  case c.relkind
    when 'r' then 'table'
    when 'p' then 'partitioned_table'
    when 'v' then 'view'
    when 'm' then 'materialized_view'
    when 'f' then 'foreign_table'
  end,
  null,null,null,null
from pg_class c
join pg_namespace n on n.oid = c.relnamespace
where n.nspname in (select schema_name from user_schemas)
  and c.relkind in ('r','p','v','m','f')

union all

-- =========================================================
-- COLUMNS (includes generated)
-- =========================================================
select
  'COLUMNS',
  n.nspname::text,
  c.relname::text,
  a.attname::text,
  pg_catalog.format_type(a.atttypid, a.atttypmod)::text,
  case when a.attnotnull then 'NO' else 'YES' end,
  pg_get_expr(ad.adbin, ad.adrelid)::text,
  case when a.attgenerated <> '' then 'GENERATED' else null end
from pg_attribute a
join pg_class c on a.attrelid = c.oid
join pg_namespace n on n.oid = c.relnamespace
left join pg_attrdef ad on ad.adrelid = a.attrelid and ad.adnum = a.attnum
where n.nspname in (select schema_name from user_schemas)
  and a.attnum > 0
  and not a.attisdropped

union all

-- =========================================================
-- CONSTRAINTS (includes CHECK definitions)
-- =========================================================
select
  'CONSTRAINTS',
  n.nspname::text,
  c.relname::text,
  con.conname::text,
  con.contype::text,
  pg_get_constraintdef(con.oid)::text,
  null,null
from pg_constraint con
join pg_class c on con.conrelid = c.oid
join pg_namespace n on n.oid = c.relnamespace
where n.nspname in (select schema_name from user_schemas)

union all

-- =========================================================
-- INDEXES
-- =========================================================
select
  'INDEXES',
  schemaname::text,
  tablename::text,
  indexname::text,
  indexdef::text,
  null,null,null
from pg_indexes
where schemaname in (select schema_name from user_schemas)

union all

-- =========================================================
-- RLS POLICIES
-- =========================================================
select
  'RLS_POLICIES',
  schemaname::text,
  tablename::text,
  policyname::text,
  cmd::text,
  roles::text,
  qual::text,
  with_check::text
from pg_policies
where schemaname in (select schema_name from user_schemas)

union all

-- =========================================================
-- RLS ENABLED
-- =========================================================
select
  'RLS_ENABLED',
  n.nspname::text,
  c.relname::text,
  c.relrowsecurity::text,
  c.relforcerowsecurity::text,
  null,null,null
from pg_class c
join pg_namespace n on n.oid = c.relnamespace
where n.nspname in (select schema_name from user_schemas)
  and c.relkind in ('r','p')

union all

-- =========================================================
-- FUNCTIONS
-- =========================================================
select
  'FUNCTIONS',
  n.nspname::text,
  p.proname::text,
  pg_get_function_identity_arguments(p.oid)::text,
  pg_get_functiondef(p.oid)::text,
  null,null,null
from pg_proc p
join pg_namespace n on n.oid = p.pronamespace
where n.nspname in (select schema_name from user_schemas)

union all

-- =========================================================
-- VIEWS
-- =========================================================
select
  'VIEWS',
  schemaname::text,
  viewname::text,
  definition::text,
  null,null,null,null
from pg_views
where schemaname in (select schema_name from user_schemas)

union all

-- =========================================================
-- TRIGGERS
-- =========================================================
select
  'TRIGGERS',
  event_object_schema::text,
  event_object_table::text,
  trigger_name::text,
  action_timing || ' ' || event_manipulation,
  action_statement::text,
  null,null
from information_schema.triggers
where event_object_schema in (select schema_name from user_schemas)

union all

-- =========================================================
-- ENUMS
-- =========================================================
select
  'ENUMS',
  n.nspname::text,
  t.typname::text,
  e.enumlabel::text,
  null,null,null,null
from pg_type t
join pg_enum e on t.oid = e.enumtypid
join pg_namespace n on n.oid = t.typnamespace
where n.nspname in (select schema_name from user_schemas)

union all

-- =========================================================
-- TABLE GRANTS
-- =========================================================
select
  'TABLE_GRANTS',
  table_schema::text,
  table_name::text,
  grantee::text,
  privilege_type::text,
  is_grantable::text,
  grantor::text,
  null
from information_schema.role_table_grants
where table_schema in (select schema_name from user_schemas)

union all

-- =========================================================
-- ROLES (non-system)
-- =========================================================
select
  'ROLES',
  rolname::text,
  rolcanlogin::text,
  rolinherit::text,
  rolcreaterole::text,
  rolcreatedb::text,
  rolreplication::text,
  rolbypassrls::text
from pg_roles
where rolname not like 'pg_%'

order by 1,2,3,4;
